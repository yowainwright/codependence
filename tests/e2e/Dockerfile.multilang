# Multi-language Dockerfile for testing codependence with Python and Go
FROM node:24-slim AS builder

# Install build tools
RUN apt-get update && apt-get install -y \
    curl \
    unzip \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files
COPY package.json ./
COPY bun.lock ./
COPY bunfig.toml ./
COPY page/ ./page/

# Install bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install Node.js dependencies
RUN bun install --frozen-lockfile --ignore-scripts

# Copy source code and build
COPY . .
RUN bun run build-dist

# Multi-language test stage with Python and Go
FROM node:24-slim AS multilang-test

# Install system dependencies for Python, Go, and other tools
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Go
ARG GO_VERSION=1.21.5
RUN wget -q https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz && \
    rm go${GO_VERSION}.linux-amd64.tar.gz

ENV PATH="/usr/local/go/bin:$PATH"
ENV GOPATH="/go"
ENV PATH="$GOPATH/bin:$PATH"

# Install bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install Python package managers
RUN pip3 install --no-cache-dir pip --upgrade && \
    pip3 install --no-cache-dir poetry pipenv

# Create test user
RUN groupadd -g 1001 testuser && \
    useradd -r -u 1001 -g testuser testuser && \
    mkdir -p /go && \
    chown -R testuser:testuser /go

WORKDIR /test

# Copy built distribution from builder
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/bun.lock ./bun.lock
COPY --from=builder /app/bunfig.toml ./bunfig.toml
COPY --from=builder /app/page ./page

# Install production dependencies
RUN bun install --production --frozen-lockfile --ignore-scripts

# Copy all test fixtures
COPY tests/e2e/fixtures/ ./

# Make all test scripts executable
RUN chmod +x *.sh

# Change ownership
RUN chown -R testuser:testuser /test

# Switch to test user
USER testuser

# Set default command to run Python/Go tests
CMD ["./test-python-go.sh"]
